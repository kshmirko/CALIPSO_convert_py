# -*- coding: utf-8 -*-
"""
Created on Wed May  7 11:26:13 2014

@author: РђРґРјРёРЅРёСЃС‚СЂР°С‚РѕСЂ
"""

import netCDF4 as nc4
from pyhdf import SD, VS
import os
import numpy as np
from datetime import datetime

PROFLE_LEN=583

Lid = np.array([39.7956696, 39.4962883, 39.196907, 38.897522, 38.5981407, 
              38.2987595, 37.9993782, 37.6999969, 37.4006157, 37.1012344, 
              36.8018532, 36.5024719, 36.2030907, 35.9037094, 35.6043243, 
              35.3049431, 35.0055618, 34.7061806, 34.4068, 34.1074181, 
              33.8080368, 33.5086555, 33.2092743, 32.909893, 32.6105118, 
              32.3111267, 32.0117455, 31.7123661, 31.4129829, 31.1136017, 
              30.8142204, 30.5148392, 30.2154579, 29.9759521, 29.7963238, 
              29.6166935, 29.4370651, 29.2574368, 29.0778065, 28.8981781, 
              28.7185497, 28.5389194, 28.3592911, 28.1796627, 28.0000324, 
              27.8204041, 27.6407757, 27.4611473, 27.281517, 27.1018887, 
              26.9222603, 26.74263, 26.5630016, 26.3833733, 26.203743, 
              26.0241146, 25.8444862, 25.664856, 25.4852276, 25.3056, 25.1259689, 
              24.9463406, 24.7667122, 24.5870838, 24.4074535, 24.2278252, 
              24.0481968, 23.8685665, 23.6889381, 23.5093098, 23.3296795, 
              23.1500511, 22.9704227, 22.7907925, 22.6111641, 22.4315357, 
              22.2519073, 22.0722771, 21.8926487, 21.7130203, 21.53339, 
              21.3537617, 21.1741333, 20.994503, 20.8148746, 20.6352463, 
              20.455616, 20.2759876, 20.1562347, 20.0963593, 20.0364819, 
              19.9766064, 19.916729, 19.8568535, 19.796978, 19.7371, 19.6772251, 
              19.6173477, 19.5574722, 19.4975948, 19.4377193, 19.3778439, 
              19.3179665, 19.258091, 19.1982136, 19.1383381, 19.0784607, 
              19.0185852, 18.9587078, 18.8988323, 18.8389568, 18.7790794, 
              18.7192039, 18.6593266, 18.5994511, 18.5395737, 18.4796982, 
              18.4198227, 18.3599453, 18.3000698, 18.2401924, 18.1803169, 
              18.1204395, 18.060564, 18.0006866, 17.9408112, 17.8809357, 
              17.8210583, 17.7611828, 17.7013054, 17.6414299, 17.5815525, 
              17.521677, 17.4618015, 17.4019241, 17.3420486, 17.2821712, 
              17.2222958, 17.1624184, 17.1025429, 17.0426674, 16.98279, 
              16.9229145, 16.8630371, 16.8031616, 16.7432842, 16.6834087, 
              16.6235313, 16.5636559, 16.5037804, 16.443903, 16.3840275, 
              16.3241501, 16.2642746, 16.2043972, 16.1445217, 16.0846462, 
              16.0247688, 15.9648924, 15.9050159, 15.8451405, 15.785264, 
              15.7253876, 15.6655111, 15.6056347, 15.5457582, 15.4858818, 
              15.4260054, 15.3661299, 15.3062534, 15.246377, 15.1865005, 
              15.1266241, 15.0667477, 15.0068712, 14.9469948, 14.8871193, 
              14.8272429, 14.7673664, 14.70749, 14.6476135, 14.5877371, 
              14.5278606, 14.4679842, 14.4081087, 14.3482323, 14.2883558, 
              14.2284794, 14.1686029, 14.1087265, 14.0488501, 13.9889736, 
              13.9290981, 13.8692217, 13.8093452, 13.7494688, 13.6895924, 
              13.6297159, 13.5698395, 13.509963, 13.4500875, 13.3902111, 
              13.3303347, 13.2704582, 13.2105818, 13.1507053, 13.0908289, 
              13.0309525, 12.971077, 12.9112005, 12.8513241, 12.7914476, 
              12.7315712, 12.6716948, 12.6118183, 12.5519419, 12.4920664, 
              12.4321899, 12.3723135, 12.3124371, 12.2525606, 12.1926842, 
              12.1328077, 12.0729313, 12.0130558, 11.9531794, 11.8933029, 
              11.8334265, 11.77355, 11.7136736, 11.6537971, 11.5939207, 
              11.5340452, 11.4741688, 11.4142923, 11.3544159, 11.2945395, 
              11.234663, 11.1747866, 11.1149111, 11.0550346, 10.9951582, 
              10.9352818, 10.8754053, 10.8155289, 10.7556524, 10.695776, 
              10.6359005, 10.5760241, 10.5161476, 10.4562712, 10.3963947, 
              10.3365183, 10.2766418, 10.2167654, 10.1568899, 10.0970135, 
              10.037137, 9.97726059, 9.91738415, 9.85750771, 9.79763126, 
              9.73775482, 9.67787933, 9.61800289, 9.55812645, 9.49825, 
              9.43837357, 9.37849712, 9.31862068, 9.25874424, 9.19886875, 
              9.13899231, 9.07911587, 9.01923943, 8.95936298, 8.89948654, 
              8.83961, 8.77973366, 8.71985817, 8.65998173, 8.60010529, 
              8.54022884, 8.4803524, 8.42047596, 8.36059952, 8.30072308, 
              8.24084759, 8.19594, 8.16600132, 8.13606358, 8.10612583, 
              8.07618713, 8.04624939, 8.01631069, 7.98637295, 7.95643473, 
              7.92649651, 7.89655828, 7.86662, 7.83668184, 7.80674362, 
              7.77680588, 7.74686766, 7.71692944, 7.68699121, 7.65705299, 
              7.62711477, 7.59717655, 7.56723833, 7.53730059, 7.50736237, 
              7.47742414, 7.44748592, 7.4175477, 7.38760948, 7.35767126, 
              7.32773352, 7.2977953, 7.26785707, 7.23791885, 7.20798063, 
              7.17804241, 7.14810419, 7.11816597, 7.08822823, 7.05829, 
              7.02835178, 6.99841356, 6.96847534, 6.93853712, 6.9085989, 
              6.87866068, 6.84872293, 6.81878471, 6.78884649, 6.75890827, 
              6.72897, 6.69903183, 6.66909361, 6.63915539, 6.60921764, 
              6.57927942, 6.5493412, 6.51940298, 6.48946476, 6.45952654, 
              6.42958832, 6.39965, 6.36971235, 6.33977413, 6.30983591, 
              6.27989769, 6.24995947, 6.22002125, 6.19008303, 6.16014481, 
              6.13020706, 6.10026884, 6.07033062, 6.0403924, 6.01045418, 
              5.98051596, 5.95057774, 5.92063951, 5.89070177, 5.86076355, 
              5.83082533, 5.80088711, 5.77094889, 5.74101067, 5.71107244, 
              5.68113422, 5.65119648, 5.62125826, 5.59132, 5.56138182, 
              5.5314436, 5.50150537, 5.47156715, 5.44162893, 5.41169119, 
              5.38175297, 5.35181475, 5.32187653, 5.2919383, 5.262, 5.23206186, 
              5.20212364, 5.1721859, 5.14224768, 5.11230946, 5.08237123, 
              5.05243301, 5.02249479, 4.99255657, 4.96261835, 4.93268061, 
              4.90274239, 4.87280416, 4.84286594, 4.81292772, 4.7829895, 
              4.75305128, 4.72311306, 4.69317532, 4.66323709, 4.63329887, 
              4.60336065, 4.57342243, 4.54348421, 4.51354599, 4.48360825, 
              4.45367, 4.4237318, 4.39379358, 4.36385536, 4.33391714, 4.30397892, 
              4.2740407, 4.24410295, 4.21416473, 4.18422651, 4.15428829, 
              4.12435, 4.09441185, 4.06447363, 4.03453541, 4.00459766, 
              3.9746592, 3.94472122, 3.914783, 3.88484478, 3.85490656, 
              3.82496858, 3.79503036, 3.76509213, 3.73515391, 3.70521593, 
              3.67527771, 3.64533949, 3.61540127, 3.58546329, 3.55552506, 
              3.52558684, 3.49564862, 3.46571064, 3.43577242, 3.4058342, 
              3.37589598, 3.34595799, 3.31601977, 3.28608155, 3.25614333, 
              3.22620535, 3.19626713, 3.16632891, 3.13639069, 3.1064527, 
              3.07651448, 3.04657626, 3.01663804, 2.9867, 2.95676184, 2.92682362, 
              2.8968854, 2.86694741, 2.83700919, 2.80707097, 2.77713275, 
              2.74719477, 2.71725655, 2.68731833, 2.65738, 2.62744212, 
              2.5975039, 2.56756568, 2.53762746, 2.50768948, 2.47775126, 
              2.44781303, 2.41787481, 2.38793683, 2.35799861, 2.32806039, 
              2.29812217, 2.26818419, 2.23824596, 2.20830774, 2.17836952, 
              2.14843154, 2.11849332, 2.0885551, 2.05861688, 2.02867889, 
              1.99874067, 1.96880245, 1.93886435, 1.90892613, 1.87898803, 
              1.84904981, 1.8191117, 1.7891736, 1.75923538, 1.72929728, 
              1.69935906, 1.66942096, 1.63948274, 1.60954463, 1.57960641, 
              1.54966831, 1.51973009, 1.48979199, 1.45985377, 1.42991567, 
              1.39997745, 1.37003934, 1.34010112, 1.31016302, 1.2802248, 
              1.2502867, 1.22034848, 1.19041038, 1.16047215, 1.13053405, 
              1.10059583, 1.07065773, 1.04071951, 1.01078141, 0.980843186, 
              0.950905, 0.920966864, 0.891028702, 0.861090541, 0.83115238, 
              0.801214218, 0.771276057, 0.741337895, 0.711399734, 0.681461573, 
              0.651523411, 0.62158525, 0.591647089, 0.561708927, 0.531770766, 
              0.501832604, 0.471894473, 0.441956311, 0.41201815, 0.38208, 
              0.352141827, 0.322203666, 0.292265505, 0.262327343, 0.232389182, 
              0.20245102, 0.172512859, 0.142574698, 0.112636544, 0.0826983824, 
              0.0527602211, 0.0228220616, -0.0071161, -0.0370542593, -0.0669924244, 
              -0.0969305784, -0.12686874, -0.156806901, -0.186745062, -0.216683224, 
              -0.246621385, -0.276559561, -0.306497693, -0.336435854, -0.366374016, 
              -0.396312177, -0.426250339, -0.4561885, -0.620848417, -0.920230031, 
              -1.21961164, -1.51899326, -1.81837487])


VARS = [
    ('Lid_Alt','f4',('length',),False, 4, -9999.0, True),
    ('Profile_UTC_Time','f8', ('time',), False, 4, -9999.0, True),
    ('Latitude','f4',('time',), False, 4, -9999.0, True),
    ('Longitude','f4',('time',), False, 4, -9999.0, True),
    ('Day_Night_Flag','i1',('time',), False, 4, -99, True),
    ('Land_Water_Mask','i1',('time',), False, 4, -99, True),
    ('Surface_Elevation','f4',('time',), False, 4, -9999.0, True),
    ('Perpendicular_Column_Reflectance_532','f4',('time',), False, 4, -9999.0, True),
    ('Parallel_Column_Reflectance_532','f4',('time',), False, 4, -9999.0, True),
    ('Tropopause_Height','f4',('time',), False, 4, -9999.0, True, True),
    ('Surface_Wind_Speeds','f4',('time','windlen',), False, 4, -9999.0, True),
    ('Total_Attenuated_Backscatter_532','f4',('time','length',), True, 4, -9999.0, True),
    ('Perpendicular_Attenuated_Backscatter_532','f4',('time','length',), True, 4, -9999.0, True),
    ('Attenuated_Backscatter_1064','f4',('time','length',), True, 4, -9999.0, True)
    
]

def get_date_from_fname(fname0):
    fname = os.path.basename(fname0)
    date = datetime.strptime(fname[27:46],'%Y-%m-%dT%H-%M-%S')
    F=SD.SD(fname0,SD.SDC.READ)
    id = F.select('Latitude')
    sz = max(id.dimensions().values())
    id.endaccess()
    F.end()
    return date.date().toordinal(), sz

get_date_from_fname_v = np.vectorize(get_date_from_fname)

def create_nc(nc4_file_name, length=None):
    ncF = nc4.Dataset(nc4_file_name, 'w', format='NETCDF4_CLASSIC')
    ncF.createDimension('time',length)
    ncF.createDimension('length',PROFLE_LEN)
    ncF.createDimension('windlen',2)

    ncv = {}
    for item in VARS:
        ncv[item[0]] = ncF.createVariable(item[0], item[1], item[2], zlib=item[3],
                                        complevel=item[4], fill_value=item[5])

    return ncF, ncv

def convert(fnames, outdir=None, length=None):
    date, tmp = get_date_from_fname(fnames[0])
    
    if outdir is None:
        outdir = os.path.dirname(fnames[0])
        
    dt = datetime.fromordinal(date)
    nc4_file_name = os.path.join(outdir,'CAL_LID-%s.nc4'%(datetime.strftime(dt,'%Y-%m-%d')))

    
    # NetCDF variables ids
    ncF,ncv = create_nc(nc4_file_name, length)

    ncv['Lid_Alt'][:] = Lid
    idx = 0
    for fname in fnames:
        hdfF = SD.SD(fname, SD.SDC.READ)

        i=1
        NVARS = len(VARS)

        while i<NVARS:
            item=VARS[i]
            tmph = hdfF.select(item[0])
            tmp = tmph.get()
            dims = len(item[2])
            if dims == 1:
                ncv[item[0]][idx:idx+tmp.shape[0]] = tmp 
            elif dims == 2:
                ncv[item[0]][idx:idx+tmp.shape[0],:] = tmp
            
            tmph.endaccess()
            i=i+1
        hdfF.end()
        idx+=tmp.shape[0]
    
    ncF.close()
    
    return nc4_file_name
